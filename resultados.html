<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Resultados da Vota√ß√£o</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 2rem;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 2rem;
    }
    .barra {
      margin: 1rem auto;
      width: 80%;
      background: #333;
      border-radius: 10px;
      overflow: hidden;
      height: 40px;
      position: relative;
    }
    .preenchimento {
      height: 100%;
      background: #0f0;
      text-align: right;
      padding-right: 10px;
      box-sizing: border-box;
      font-weight: bold;
      transition: width 0.5s ease;
    }
    #fullscreenBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 20px;
      font-size: 16px;
      background: #fff;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      z-index: 100;
    }
    .qrcodes {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-top: 2rem;
    }
    .qrcodes canvas {
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
    }
    #temporizador {
      margin-top: 1rem;
      font-size: 1.2rem;
      color: #aaa;
    }
    #vencedor {
      font-size: 2rem;
      color: gold;
      margin-top: 3rem;
      display: none;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</head>
<body>
  <h1 id="titulo">Vota√ß√£o</h1>
  <div id="output"></div>
  <div class="qrcodes" id="qrcodes"></div>
  <div id="temporizador">Tempo restante: 2:00</div>
  <div id="vencedor"></div>
  <button id="fullscreenBtn" onclick="entrarFullscreen()">Ecr√£ Completo</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDinh9iXkoxBeHQJ4F7F1sHKTtFVId58cs",
      authDomain: "show-448d0.firebaseapp.com",
      projectId: "show-448d0",
      storageBucket: "show-448d0.appspot.com",
      messagingSenderId: "1094257467234",
      appId: "1:1094257467234:web:284e06d3518e19af6cd63b",
      measurementId: "G-4ZDGCVB868"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const params = new URLSearchParams(window.location.search);
    const votacaoId = params.get("votacao") || "";

    const output = document.getElementById("output");
    const tituloEl = document.getElementById("titulo");
    const qrcodesEl = document.getElementById("qrcodes");
    const fullscreenBtn = document.getElementById("fullscreenBtn");
    const tempoEl = document.getElementById("temporizador");
    const vencedorEl = document.getElementById("vencedor");

    let unsubscribe = null;

    db.collection("votacoes").doc(votacaoId).get().then(doc => {
      if (doc.exists) {
        const data = doc.data();
        tituloEl.innerText = data.titulo || "Vota√ß√£o";
        gerarQRCodes(data.op1, data.op2);
        iniciarContagem(2 * 60, data.op1, data.op2);
      } else {
        tituloEl.innerText = "Vota√ß√£o n√£o encontrada.";
      }
    }).catch(() => {
      tituloEl.innerText = "Erro ao carregar vota√ß√£o.";
    });

    function carregarVotos(op1, op2) {
      unsubscribe = db.collection("votos").onSnapshot(snapshot => {
        let votos1 = 0;
        let votos2 = 0;
        let total = 0;

        snapshot.forEach(doc => {
          const d = doc.data();
          if (d.votacao === votacaoId) {
            if (d.musica === op1) votos1++;
            if (d.musica === op2) votos2++;
            total++;
          }
        });

        const p1 = total > 0 ? Math.round((votos1 / total) * 100) : 0;
        const p2 = total > 0 ? Math.round((votos2 / total) * 100) : 0;

        output.innerHTML = "";

        const barra1 = document.createElement("div");
        barra1.className = "barra";
        barra1.innerHTML = `<div class='preenchimento' style='width:${p1}%' >${op1}: ${p1}%</div>`;

        const barra2 = document.createElement("div");
        barra2.className = "barra";
        barra2.innerHTML = `<div class='preenchimento' style='width:${p2}%' >${op2}: ${p2}%</div>`;

        output.appendChild(barra1);
        output.appendChild(barra2);

        // Guardar info para o final
        output.dataset.p1 = p1;
        output.dataset.p2 = p2;
        output.dataset.op1 = op1;
        output.dataset.op2 = op2;
      });
    }

    function gerarQRCodes(op1, op2) {
      qrcodesEl.innerHTML = "";
      [op1, op2].forEach(musica => {
        const div = document.createElement("div");
        const url = `https://votacaoqrcode.pt/votar.html?musica=${encodeURIComponent(musica)}&votacao=${votacaoId}`;
        QRCode.toCanvas(url, (err, canvas) => {
          if (!err) {
            div.appendChild(canvas);
            const label = document.createElement("p");
            label.innerText = musica;
            label.style.marginTop = "0.5rem";
            label.style.color = "#fff";
            label.style.fontWeight = "bold";
            label.style.textAlign = "center";
            div.appendChild(label);
            qrcodesEl.appendChild(div);
          }
        });
      });
    }

    function entrarFullscreen() {
      fullscreenBtn.style.display = "none";
      const el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();
    }

    function iniciarContagem(segundos, op1, op2) {
      carregarVotos(op1, op2);
      let tempo = segundos;

      const intervalo = setInterval(() => {
        const min = String(Math.floor(tempo / 60)).padStart(2, "0");
        const sec = String(tempo % 60).padStart(2, "0");
        tempoEl.innerText = `Tempo restante: ${min}:${sec}`;

        if (tempo <= 0) {
          clearInterval(intervalo);
          tempoEl.innerText = "Vota√ß√£o encerrada!";
          if (unsubscribe) unsubscribe(); // parar atualiza√ß√µes

          // Mostrar vencedor
          const p1 = parseInt(output.dataset.p1 || 0);
          const p2 = parseInt(output.dataset.p2 || 0);
          const op1txt = output.dataset.op1 || "Op√ß√£o 1";
          const op2txt = output.dataset.op2 || "Op√ß√£o 2";

          if (p1 > p2) {
            vencedorEl.innerText = `üéâ ${op1txt} venceu com ${p1}%!`;
          } else if (p2 > p1) {
            vencedorEl.innerText = `üéâ ${op2txt} venceu com ${p2}%!`;
          } else {
            vencedorEl.innerText = `‚öñÔ∏è Empate! Ambas t√™m ${p1}%`;
          }

          vencedorEl.style.display = "block";
        }

        tempo--;
      }, 1000);
    }
  </script>
</body>
</html>
